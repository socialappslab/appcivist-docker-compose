FROM ubuntu:14.04
MAINTAINER Cristhian Parra <cdparra@gmail.com>
ENV PRODUCTION_HOME /home/appcivist/production
ENV PROJECT_HOME /home/appcivist/production/appcivist-platform

# Create editor userspace
RUN groupadd appcivist
RUN useradd appcivist -m -g appcivist -s /bin/bash
RUN passwd -d -u appcivist
RUN echo "appcivist ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/appcivist
RUN chmod 0440 /etc/sudoers.d/appcivist
RUN mkdir -p ${PRODUCTION_HOME}



# Install dependencies
ENV ACTIVATOR_VERSION 1.3.12
RUN apt-get update && \
    apt-get install -y git build-essential curl wget zip unzip software-properties-common
WORKDIR /tmp

# Install play
RUN wget http://downloads.typesafe.com/typesafe-activator/${ACTIVATOR_VERSION}/typesafe-activator-${ACTIVATOR_VERSION}.zip && \
    unzip typesafe-activator-${ACTIVATOR_VERSION}.zip && \
    mv activator-dist-${ACTIVATOR_VERSION} /opt/activator && \
    chown -R appcivist:appcivist /opt/activator && \
    rm typesafe-activator-${ACTIVATOR_VERSION}.zip



RUN chmod a+x /opt/activator
## Remove any existing JDKs
RUN apt-get --purge remove openjdk*


## Install Oracle's JDK
RUN wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u161-b12/2f38c3b165be4555a1fa6e98c45e0808/jdk-8u161-linux-x64.tar.gz
RUN tar -zxvf jdk-8u*-linux-*.tar.gz
RUN mv jdk1.8.*/ /usr/
RUN update-alternatives --install /usr/bin/java java /usr/jdk1.8.*/bin/java 2
RUN update-alternatives --config java
# Define commonly used JAVA_HOME variable
ENV JAVA_HOME /usr/lib/jvm/java-8-oracle
RUN echo "export PATH=$PATH:/opt/activator/bin" >> /home/appcivist/.bashrc

WORKDIR ${PRODUCTION_HOME}

#clone the project, set permissions and get the last changes
RUN git clone https://github.com/socialappslab/appcivist-platform.git
RUN chown appcivist:appcivist ${PROJECT_HOME}
WORKDIR ${PROJECT_HOME}
RUN git pull

# Define user home. Activator will store ivy2 and sbt caches on ${PROJECT_HOME} volume
RUN echo "export _JAVA_OPTIONS='-Duser.home=${PROJECT_HOME}'" >> /home/appcivist/.bashrc

#Add init script
ADD appcivist-backend /etc/init.d/appcivist-backend

# Change user, launch bash
USER appcivist
RUN /bin/bash -c "source ~/.bashrc"
WORKDIR /home/appcivist

# Expose play ports 9000 default 9999 debug 8888 activator ui
EXPOSE 9000
EXPOSE 9999
EXPOSE 8888

#build the project and start it
WORKDIR ${PROJECT_HOME}
RUN ./activator clean
RUN ./activator stage 
CMD /etc/init.d/appcivist-backend start
